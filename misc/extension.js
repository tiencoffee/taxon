(async function(){var e,t,n,r,i,a,o,c,s,l,u,p,d,h,y,f,g,b,k,K,w,v,x,S,E,L,T,z,A,q,Z,C,R,D,N,j,I,_,M,$,B,H,P,U,O,G,W,F,V,Q=[].join,J=[].slice,X=Array.from||function(e){return J.call(e)};for(e=location.hostname,t=/\bwiki[mp]edia\b/.test(e),n=/\.wikipedia\.org$/.test(e),r=/\bimgur\b/.test(e),i=/\bgoogle\b/.test(e),a=void 0,0,o="",c=null,s=!1,l="",u=getSelection(),p=!1,d=null,h=null,y=!1,f=null,b=0,k=(g=[["vực|siêu giới|domain|super-?kingdom","",""],["giới|kingdom","",""],["phân giới|sub-?kingdom","",""],["thứ giới|infra-?kingdom","",""],["liên ngành|siêu ngành|super-?phylum","",""],["ngành|phylum","KeyN","phylum"],["phân ngành|sub-?phylum","",""],["thứ ngành|infra-?phylum","",""],["tiểu ngành|micro-?phylum","",""],["liên lớp|siêu lớp|super-?class","KeyS","superclass"],["lớp|class","KeyX","class"],["phân lớp|sub-?class","KeyD","subclass"],["thứ lớp|infra-?class","",""],["tiểu lớp|parv-?class","",""],["đoàn|legion","",""],["liên đội|super-?cohort","",""],["đội|cohort","",""],["tổng bộ|đại bộ|magn-?order","",""],["liên bộ|siêu bộ|super-?order","KeyG","superorder"],["bộ|order","KeyB","order"],["phân bộ|sub-?order","KeyJ","suborder"],["thứ bộ|infra-?order","",""],["tiểu bộ|parv-?order","",""],["liên họ|siêu họ|super-?family","KeyY","superfamily"],["họ|family","KeyH","family"],["phân họ|sub-?family","KeyU","subfamily"],["liên tông|super-?tribe","Digit5","supertribe"],["tông|tribe","KeyT","tribe"],["phân tông|sub-?tribe","Digit6","subtribe"],["chi|genus","KeyC","genus"],["phân chi|sub-?genus","KeyF","subgenus"],["mục|section","",""],["loạt|series","",""],["liên loài|super-?species","",""],["loài|species","KeyL","species"],["phân loài|sub-?species","KeyP","subspecies"],["thứ|variety","",""],["dạng|form","",""]]).length;b<k;++b)K=b,(w=g[b])[3]=K,w[4]=RegExp("^(?:"+w[0]+"):?\\s+","i"),w[5]=RegExp("^(?:"+w[0]+")$","i");v=[/[\r\n]+/,/[\r\n]+|\s–\s|\s\-\s/],x=g.map(function(e){return e[0]}).join("|"),S=RegExp("^(?:"+x+"):?\\s+","i"),E=/\b(?:tuyệt chủng|extinct|fossil)\b|†/i,L=/(Control|Shift|Alt|Meta)(Left|Right)|(Caps|Num)Lock|Tab/,T=v[+("species.wikimedia.org"===e)],z=/(?<=^[A-Z]\.\s*[a-z-]+\s)[a-z-]+|(?<=^[A-Z]\.\s*[-a-z]\.\s*)[-a-z]+|(?<=^[A-Z][a-z]+\s[-a-z]+\s)[-a-z]+|(?<=^[A-Z][a-z]+\s[-a-z]\.\s*)[-a-z]+/,A=/(?<=^[A-Z]\.\s*[a-z]\.\s*)[a-zA-Z0-9]+\s[-a-zA-Z0-9]+|(?<=^[A-Z][a-z]+\s[-a-z]+\s)[a-zA-Z0-9]+\s[-a-zA-Z0-9]+|(?<=^[A-Z]\.\s*[a-z]\.\s*)[-a-zA-Z0-9.\/]+|(?<=^[A-Z][a-z]+\s[a-z\-]+\s)[a-zA-Z0-9\-\/\.]+/,q=/(?<=^[A-Z]\.\s*)[-a-z]+|(?<=^[A-Z][a-z]+\s)[-a-z]+/,Z=g.filter(function(e){return e[2]}).map(function(e){return"."+e[2]}).join(","),o="",C="",R=[],D=null,N=!0,m.class=function(...e){var t,n,r,i,a,o;for(t=[],n=0,i=(r=e).length;n<i;++n)if(a=r[n],Array.isArray(a))t.push(m.class.apply(m,a));else if(a instanceof Object)for(o in a)a[o]&&t.push(o);else null!=a&&t.push(a);return Q.call(t," ")},m.bind=function(e,t){var n,r;for(n in null==t&&(t=e),e)"function"!=typeof(r=e[n])||/(bound|class) /.test(r.name)||(e[n]=r.bind(t));return e},j=function(e){var t,n,r,i;for(t=[],n=0,r=e.length;n<r;++n)i=e[n],t.includes(i)||t.push(i);return e.splice.apply(e,[0,e.length].concat(X(t))),e},I=function(e){if(null!=e)return u.empty(),navigator.clipboard.writeText(e)},_=function(e){var t,n,r,i;document.activeElement.blur(),(t=document.body.createTextRange)?((n=r=t()).moveToElementText(e),n.select()):getSelection?((r=document.createRange()).selectNodeContents(e),(i=u).removeAllRanges(),i.addRange(r)):console.warn("Trình duyệt không hỗ trợ Selection.")},M=function(){return!/^(?:input|textarea)$/.test(document.activeElement.localName)},$=function(e){var t;"string"==typeof e&&(e={code:e}),t=new KeyboardEvent("keyup",e),dispatchEvent(t)},B=function(e,t){var n,r,i,a;null==t&&(t="solid 2px #07d"),R.includes(e)||(n=e.style,r=n.outline,i=n.outlineOffset,(a=e.style).outline=t,a.outlineOffset="-1px",R.push(e),setTimeout(function(){var t;(t=e.style).outline=r,t.outlineOffset=i,R.splice(R.indexOf(e),1)},400))},H=function(e){null==e&&(e=D),null!=e&&e.parentElement.querySelectorAll("ul").forEach(function(e){return e.hidden=!0})},P=function(e){null==e&&(e=D),null!=e&&e.parentElement.querySelectorAll("ul").forEach(function(e){return e.hidden=!1})},U=function(e){var t,n,r,i,a,o,c,s;if(null==e&&(e=D),e)if(r=(t=e.parentElement)[n="$_Taxonomy_keepITagUl_innerHTML"])t.innerHTML=r,delete t[n];else{for(t[n]=t.innerHTML,i=0,o=(a=t.children).length;i<o;++i)s=(c=a[i]).querySelector("i").innerText,E.test(c.innerText)&&(s+=" †"),c.innerText=s;_(t)}},O=function(e,t){var n,r;null==t&&(t=5e3),(n=r=document.createElement("div")).className="taxonNotify",n.innerHTML=e,document.body.appendChild(r),setTimeout(function(){r.remove()},t)},G=function(){return open("https://api.imgur.com/oauth2/authorize?client_id=92ac14aabe20918&response_type=token&state=taxon","_blank")},W=async function(e){var n,r;c&&(c.destroy(),c=null),i?(document.querySelector(".hm60ue"),3===(n=document.querySelectorAll(".VSIspc")).length&&n[1].remove(),3===(n=document.querySelectorAll(".ZGGHx")).length&&n[1].remove(),(e=(e=document.querySelectorAll(".n3VNCb"))[3===e.length?1:0]).parentElement.href="javascript:",r=await(await fetch("https://cors-anywhere.herokuapp.com/"+e.src)).blob(),e.src=await new Promise(function(e){var t;(t=new FileReader).onload=function(t){e(t.target.result)},t.readAsDataURL(r)})):t&&document.querySelector(".mw-mmv-download-dialog"),e&&(c=new Cropper(e,{checkCrossOrigin:!1,zoomable:!1,guides:!1,center:!1,ready:function(){this.cropper.setCropBoxData({left:0,top:0,width:0,height:0})}}))},F=async function(e,t){var n,r,i,a,o,u,m;r=(n=null!=e?e:{}).image,i=n.type,s=!0,l?(O("Đang upload ảnh imgur..."),(a=o=new FormData).append("image",r),a.append("album","RPTWQrk"),a.append("type",i),(u=await fetch("https://api.imgur.com/3/image",{method:"post",headers:{Authorization:"Bearer "+l},body:o})).ok?200===(u=await u.json()).status?(c&&(c.destroy(),c=null),await I(" # "+u.data.id),location.href="https://imgur.com/edit?deletehash="+u.data.deletehash+"&album_id=RPTWQrk"):m=Error("Lấy thông tin ảnh imgur thất bại"):m=Error("Upload ảnh imgur thất bại")):m=Error("Chưa có token"),m&&O(m.message),s=!1,"function"==typeof t&&t(m,u.data)},V=function(){chrome.runtime.sendMessage("closeTab")},window.addEventListener("keydown",function(e){e.repeat||L.test(e.code)||(a=e.code)}),window.addEventListener("keyup",async function(e){var n,l,u,m,d,y,f,b,k,K,w,x,Z,R,D,O,J,Y,ee,te,ne,re,ie,ae,oe,ce,se,le,ue,me,pe,de,he,ye,fe,ge,be,ke,Ke=async function(){switch(a){case"KeyP":return K.match(z);case"Semicolon":return K.match(A);case"KeyL":return K.match(q);default:return K.match(/^[A-Z][a-z]+/)}};if(p?(a=void 0,p=!1):e.isTrusted||L.test(e.code)||(a=e.code),n=e.ctrlKey,l=e.shiftKey,u=e.altKey,m=e.metaKey,d=!(n||l||u||m),n&&!l&&!u&&!m,y=!n&&l&&!u&&!m,!n&&!l&&u&&!m,!n&&!l&&!u&&m,t&&(f="Semicolon"===a||g.some(function(e){return e[1]===a}),e.shiftKey)){if(!f)return;H()}if(C=(getSelection()+"").trim(),M()){if(t){if(C){if(!e.ctrlKey&&document.activeElement===document.body){if(f){if(o="",b=C,navigator.userAgent.includes("Edge")&&(b=b.replace(/([a-z])([A-Z])/,"$1\n$2")),b=b.split(T),k=void 0,!e.isTrusted&&(K=b[0])&&("KeyL"===a||"KeyP"===a||"Semicolon"===a))switch(!1){case!(w=g.find(function(e){return e[4].test(K)})):k=w[3],a="";break;case!/^([A-Z]\.\s?[a-z]\.\s[a-z-]{2,}|[A-Z][a-z]+\s[a-z]{2,}\s[a-z-]{2,})/.test(K):a="KeyP"}for(null==k&&(k=g.findIndex(function(e){return e[1]===a}))<0&&(k=0),x="\t".repeat((ke=k)<0?0:ke),Z=0,R=b.length;Z<R;++Z)D=Z,(K=(K=b[Z]).trim()).match(E)?(K=K.replace(E,""),O=!0):O=!1,K=(K=K.trim().replace(S,"")).replace(/^"(.+)"$/,"$1"),(J=await Ke())&&(J=J[0],O&&(J+="*"),J=x+J),K=J,b[D]=K;b=b.filter(Boolean),b=X(b.filter(function(e){return!e.includes("*")})).concat(X(b.filter(function(e){return e.includes("*")}))),j(b),o=("\n"+(o+=Q.call(b,"\n"))).replace(/[\r\n]?\t*\bnull\b/g,"").replace(/\ /g," "),"KeyL"===a&&(o.trim()||$("/"))}else switch(a){case"KeyQ":d&&(C=C.replace(S,""),o=" # "+C.charAt(0).toUpperCase()+C.slice(1));break;case"Delete":d&&H();break;case"Backspace":d&&U();break;case"KeyZ":d&&(o=C)}o&&I(o)}}else switch(a){case"KeyZ":d&&history.back();break;case"KeyX":d&&history.forward();break;case"KeyC":d&&(h?h.click():document.URL.includes("commons.wikimedia.org")&&history.back());break;case"KeyS":d&&((Y=document.querySelector(".wb-otherproject-species> a"))?Y.click():document.URL.includes("species.wikimedia.org")&&history.back());break;case"KeyD":d&&(w=(ee=function(e){return document.querySelector("a.interlanguage-link-target[hreflang="+e+"]")})("vi")||ee("en"))&&w.click()}switch(a){case"KeyE":d&&o&&(o.includes("*")?o=o.replace(/\*/g,""):(o=o.replace(/([^*])\n/g,"$1*\n")).endsWith("*")||(o+="*"),I(o));break;case"KeyW":d&&V();break;case"F1":d&&(e.preventDefault(),te=g.map(function(e){return e[0].split("|").join(" | ")+e[1]}).join(": "),alert(te));break;case"KeyA":d&&(N=!N);break;case"Backquote":d&&(T=v[1]);break;case"KeyV":if(d)if(ne=document.querySelector("h2> #Species, h3> #Species")){for(ne=ne.parentElement;(ne=ne.nextElementSibling)&&"ul"!==ne.localName;)if(re=ne.querySelector("ul")){ne=re;break}ne&&(_(ne),$("KeyL"),B(ne))}else(ne=document.querySelector("table.infobox.biota .species"))&&(_(ne),$("KeyL"),B(ne));break;case"Digit2":case"Digit3":if(d){for(te="",Z=0,R=(ie=(ne=document.querySelector(".mw-parser-output")).querySelectorAll(":scope> h"+a[5])).length;Z<R;++Z)if(!(ae=ie[Z]).querySelector("#References")){for(oe=ae;"ul"!==oe.localName;)oe=oe.nextElementSibling;for(te+="\n"+"\t".repeat(29)+ae.children[0].innerText,ce=0,le=(se=oe.children).length;ce<le;++ce)if(me=(ue=se[ce]).querySelector("i").innerText.split(" ")[1],te+="\n"+"\t".repeat(34)+me,pe=ue.querySelector("ul"))for(te+="\n"+"\t".repeat(35)+me,de=0,ye=(he=pe.children).length;de<ye;++de)me!==(fe=he[de].querySelector("i").innerText.split(" ")[2])&&(te+="\n"+"\t".repeat(35)+fe)}I(te)}break;case"KeyO":Y="https://en.wikipedia.org/wiki/"+(te=await navigator.clipboard.readText()),y?open(Y):location.href=Y}y&&P()}else if(r){if("/edit"===location.pathname)switch(a){case"KeyS":d&&document.querySelector("#save").click();break;case"KeyR":d&&document.querySelector("#reset-crop").click()}else switch(a){case"KeyE":d&&document.querySelector(".post-image-option.help>a").click()}switch(a){case"KeyZ":d&&history.back();break;case"KeyW":d&&V()}}switch(a){case"KeyN":i&&d&&W();break;case"KeyM":s||d&&(document.contains(null!=c?c.element:void 0)?(ge=(ge=c.getCroppedCanvas().toDataURL("image/jpeg")).replace("data:image/jpeg;base64,",""),be="base64"):i&&(ge=document.querySelectorAll(".n3VNCb")[1].src,be="URL"),ge&&F({image:ge,type:be}));break;case"KeyK":d&&confirm("Lấy token imgur mới?")&&G();break;case"Escape":c&&d&&(c.destroy(),c=null)}}L.test(a)||(a=void 0),0}),window.addEventListener("mousedown",function(e){var n,o,c,l,u,m,d,h,y,b,k,K,w,v,x,S,E,L,T,z,A,q,R,N;if(D=null,C=(getSelection()+"").trim(),e.buttons,o=(n=e.target).localName,M())switch(e.which){case 3:switch(!1){case!r:"img"===o&&((c=document.createElement("a")).href=n.src,l=c.pathname.slice(1,8),e.altKey?I(l):(m(e.shiftKey),I(m+l)),B(n));break;case!i:"img"===o&&(e.ctrlKey||(I(n.src),B(n)));break;case!t:switch(!1){case"img"!==o:switch(a){case"KeyN":W(n),p=!0;break;case"KeyM":s||F({image:n.src,type:"URL"}),p=!0;break;default:if(!e.ctrlKey){if(u=n.src,e.altKey)I(u);else{switch(!1){case!/\/\d+px-.+/.test(u):u=u.replace("https://upload.wikimedia.org/wikipedia/commons/thumb","").replace(/\/\d+px-.+/,"");break;case!/-\d+px-.+/.test(u):u=u.replace(/-\d+px-/,"-220px-")}m=e.shiftKey?" | ":" # ",(d={KeyF:"fossil",KeyR:"restoration",KeyC:"reconstruction",KeyE:"exhibit",KeyD:"drawing",KeyH:"holotype",KeyS:"skull",KeyK:"skeleton",KeyJ:"jaw",KeyM:"mandible",KeyI:"illustration",KeyP:"specimen"}[a]||"")&&(d=" ; "+d,p=!0),I(m+u+d)}B(n)}}break;case!n.closest(".binomial"):_(n),$("KeyL"),B(n);break;case!n.closest(".trinomial"):_(n),$("KeyP"),B(n);break;case!(h=n.closest(Z)):y=g.find(function(e){return e[2]===h.className})[1],_(n),$(y),B(n);break;case!C:$("KeyL");break;case"li"!==o:e.altKey?f=["altLis",n]:(H(n),n.parentElement.firstElementChild.querySelector("i:first-child> a")||U(n),_(n.parentElement),y="KeyL",(b=n.closest(".infobox.biota")&&/Genus|Genera/.exec(n.closest("tr").previousElementSibling.innerText))||(K=null!=(k=n.parentElement)?k.previousElementSibling:void 0)&&(b=K.querySelector("#Genera")||(null!=(w=K.previousElementSibling)?w.querySelector("#Genera"):void 0)),b&&(y="KeyC"),$(y),B(n.parentElement));break;case!n.closest(".infobox.biota"):e.altKey?f=["altLisInfoboxBiota",n]:(v=n.closest("a:not(.selflink)"))?f=["aInfoboxBiota",v]:(y="KeyL",(x=n.closest("td"))&&(E=null!=(S=x.previousElementSibling)?S.innerText.trim().toLowerCase().replace(/[^a-z]/g,""):void 0)&&(L=g.find(function(e){return e[5].test(E)}))&&(y=L[1]),(T=x.querySelector("a"))&&(x=T),_(x),$(y),B(x));break;case!(("th"===o||"td"===o)&&(z=n.closest("table"))):e.ctrlKey||(A=e.shiftKey?X(z.rows).filter(function(e){var t,n,r,i;if((t=X(e.cells)).every(function(e){return"th"===e.localName}))return!1;for(n=0,r=t.length;n<r;++n)(i=t[n]).rowSpan>1&&i.remove();return!0}).map(function(e){return e.cells[n.cellIndex]}):X(z.rows).slice(n.parentElement.rowIndex).map(function(e){return e.cells[n.cellIndex]}),(q=R=document.createElement("ul")).className="pointer-events-none",q.innerHTML=A.map(function(e){return"<li>"+e.innerHTML+"</li>"}).join(""),z.replaceWith(R),_(R),$(a||"KeyL"),B(R));break;case!(N=n.closest("#firstHeading,b,h1,h2,h3,h4,h5,h6")):_(N),$("KeyQ"),B(N)}}}},!0),window.addEventListener("mouseup",function(e){var n,i,o,c,s,l,u,m,p,d,h,y,g,b;switch(D=null,i=(n=e.target).localName,e.which){case 1:switch(!1){case!t:1===e.detail&&(/^(li|a|b|i)$/.test(i)||"p"===i&&n.closest(".infobox.biota"))&&(e.altKey||N&&("a"!==i||"a"===i&&!n.href)&&(_(n.parentElement),D=n));break;case!r:1===e.detail&&"img"===i&&n.closest(".post-image-container").querySelector(".post-image-option.help>a").click()}break;case 3:if(t){if(f){switch(o=f[0],c=J.call(f,1),o){case"altLis":for(l="$_Taxonomy_linkOpened",u=0,m=!1,p=0,h=(d=(s=c[0]).parentElement.children).length;p<h&&((y=d[p])[l]||(y[l]=!0,!(g=y.querySelector(":scope> i> a:not(.new), :scope> a:not(.new)"))||(g.style.textDecoration="underline",e.shiftKey||(m=!0,open(g.href)),10!=++u)));++p);u||B(s.parentElement,"solid 2px #f43"),m&&chrome.extension.sendMessage("openTabs");break;case"altLisInfoboxBiota":for(l="$_Taxonomy_linkOpened",u=0,m=!1,p=0,h=(d=(s=c[0]).children).length;p<h&&((y=d[p])[l]||(y[l]=!0,!(g=y.querySelector(":scope> a:not(.new)"))||(g.style.textDecoration="underline",e.shiftKey||(m=!0,open(g.href)),10!=++u)));++p);u||B(s,"solid 2px #f43"),m&&chrome.extension.sendMessage("openTabs");break;case"aInfoboxBiota":g=c[0],open(g.href)}f=null}else"a"!==i||n.classList.contains("selflink")||(n.style.textDecoration="underline",open(n.href));(b=document.querySelector("ul.pointer-events-none"))&&b.classList.remove("pointer-events-none")}}a||0},!0),window.addEventListener("contextmenu",function(e){e.x&&e.preventDefault()},!0),r||chrome.storage.sync.get(["token","tokenTime"],function(e){var t,n,r;l=e.token,t=e.tokenTime,l&&t+6048e5>Date.now()||(n=G(),r=setInterval(function(){n.closed&&(clearInterval(r),chrome.storage.sync.get(["token"],function(e){l=e.token}))},1e3))}),window.addEventListener("load",async function(){var e,i,a,o;switch(!1){case!t:n&&((d=document.querySelector("a.interlanguage-link-target[hreflang=vi]"))&&(e=/[^\/]+$/.exec(d.href)[0]),(h=document.querySelector(".wb-otherproject-commons> a"))&&((i=document.createElement("link")).rel="prerender",i.href=h.href,document.head.appendChild(i)),y=content.innerText.includes("subspecies"),e&&(a=await(await fetch("https://vi.wikipedia.org/api/rest_v1/page/summary/"+e)).json()),o=m.bind({view:function(){var e,t;return m(".column.taxonRightSide",m(".row-2.p-3",y?m(".text-green","Phân loài"):void 0,h?m(".text-green","Wiki common"):void 0),a?m(".col.px-3.column.f-center.scroll-y",m(".mt-1.mb-3.taxonSummaryTitle",m("b",a.title)),(t=null!=(e=a.thumbnail)?e.source:void 0)?m("img.taxonSummaryImg",{src:t}):m("p.text-red.text-center","Không có hình ảnh"),m("p.taxonSummaryExtract",m.trust(a.extract_html))):m(".col.text-red.text-center","Không có tiếng Việt"))}}),i=document.createElement("div"),document.body.appendChild(i),m.mount(i,o));break;case!r:"?state=taxon"===location.search&&(l=/access_token=([a-z0-9]+)/.exec(location.hash)[1],chrome.storage.sync.set({token:l,tokenTime:Date.now()},V))}})}).call(this);