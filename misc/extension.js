(async function(){var e,t,n,i,a,r,o,c,l,s,u,d,p,h,y,f,g,b,v,k,K,x,w,S,E,z,L,T,A,q,Z,C,R,D,N,_,j,M,I,$,H,O,B,U,P,W,V,F,Q=[].join,G=[].slice,J=Array.from||function(e){return G.call(e)};for(e=location.hostname,t=/\bwiki[mp]edia\b/.test(e),/\.wikipedia\.org$/.test(e),n=/\bimgur\b/.test(e),i=/\bgoogle\b/.test(e),a=void 0,0,r="",o=null,c=!1,l="",s=getSelection(),u=!1,d=null,p=null,h=!1,y=null,g=0,b=(f=[["vực|siêu giới|domain|super-?kingdom","","",void 0],["giới|kingdom","","",void 0],["phân giới|sub-?kingdom","","",void 0],["thứ giới|infra-?kingdom","","",void 0],["liên ngành|siêu ngành|super-?phylum","","",void 0],["ngành|phylum","KeyN","phylum",void 0],["phân ngành|sub-?phylum","","",void 0],["thứ ngành|infra-?phylum","","",void 0],["tiểu ngành|micro-?phylum","","",void 0],["liên lớp|siêu lớp|super-?class","KeyS","superclass",void 0],["lớp|class","KeyX","class",void 0],["phân lớp|sub-?class","KeyD","subclass",void 0],["thứ lớp|infra-?class","","",void 0],["tiểu lớp|parv-?class","","",void 0],["đoàn|legion","","",void 0],["liên đội|super-?cohort","","",void 0],["đội|cohort","","",void 0],["tổng bộ|đại bộ|magn-?order","","",void 0],["liên bộ|siêu bộ|super-?order","KeyG","superorder",void 0],["bộ|order","KeyB","order",void 0],["phân bộ|sub-?order","KeyJ","suborder",void 0],["thứ bộ|infra-?order","","",void 0],["tiểu bộ|parv-?order","","",void 0],["liên họ|siêu họ|super-?family","KeyY","superfamily","oidea"],["họ|family","KeyH","family","idae"],["phân họ|sub-?family","KeyU","subfamily","inae"],["liên tông|super-?tribe","Digit5","supertribe",void 0],["tông|tribe","KeyT","tribe","ini"],["phân tông|sub-?tribe","Digit6","subtribe",void 0],["chi|genus","KeyC","genus",void 0],["phân chi|sub-?genus","KeyF","subgenus",void 0],["mục|section","","",void 0],["loạt|series","","",void 0],["liên loài|super-?species","","",void 0],["loài|species","KeyL","species",void 0],["phân loài|sub-?species","KeyP","subspecies",void 0],["thứ|variety","","",void 0],["dạng|form","","",void 0]]).length;g<b;++g)v=g,(k=f[g])[4]=v,k[5]=RegExp("^(?:"+k[0]+"):?\\s+","i"),k[6]=RegExp("^(?:"+k[0]+")$","i"),k[7]=k[3]&&RegExp("^[A-Z][a-z]+"+k[3]+"($|\\b)");K=[/[\r\n]+/,/[\r\n]+|\s–\s|\s\-\s/],x=f.map(function(e){return e[0]}).join("|"),w=RegExp("^(?:"+x+"):?\\s+","i"),S=/\b(?:tuyệt chủng|extinct|fossil)\b|†/i,E=/(Control|Shift|Alt|Meta)(Left|Right)|(Caps|Num)Lock|Tab/,z=K[+("species.wikimedia.org"===e)],L=/(?<=^[A-Z]\.\s*[a-z-]+\s)[a-z-]+|(?<=^[A-Z]\.\s*[-a-z]\.\s*)[-a-z]+|(?<=^[A-Z][a-z]+\s[-a-z]+\s)[-a-z]+|(?<=^[A-Z][a-z]+\s[-a-z]\.\s*)[-a-z]+/,T=/(?<=^[A-Z]\.\s*[a-z]\.\s*)[a-zA-Z0-9]+\s[-a-zA-Z0-9]+|(?<=^[A-Z][a-z]+\s[-a-z]+\s)[a-zA-Z0-9]+\s[-a-zA-Z0-9]+|(?<=^[A-Z]\.\s*[a-z]\.\s*)[-a-zA-Z0-9.\/]+|(?<=^[A-Z][a-z]+\s[a-z\-]+\s)[a-zA-Z0-9\-\/\.]+/,A=/(?<=^[A-Z]\.\s*)[-a-z]+|(?<=^[A-Z][a-z]+\s)[-a-z]+/,q=f.filter(function(e){return e[2]}).map(function(e){return"."+e[2]}).join(","),r="",Z="",C=[],R=null,D=!0,m.class=function(...e){var t,n,i,a,r,o;for(t=[],n=0,a=(i=e).length;n<a;++n)if(r=i[n],Array.isArray(r))t.push(m.class.apply(m,r));else if(r instanceof Object)for(o in r)r[o]&&t.push(o);else null!=r&&t.push(r);return Q.call(t," ")},m.bind=function(e,t){var n,i;for(n in null==t&&(t=e),e)"function"!=typeof(i=e[n])||/(bound|class) /.test(i.name)||(e[n]=i.bind(t));return e},N=function(e){var t,n,i,a;for(t=[],n=0,i=e.length;n<i;++n)a=e[n],t.includes(a)||t.push(a);return e.splice.apply(e,[0,e.length].concat(J(t))),e},_=function(e){if(null!=e)return s.empty(),navigator.clipboard.writeText(e)},j=function(){return!/^(?:input|textarea)$/.test(document.activeElement.localName)},M=function(e,t){var n,i,a,r;a=n={code:e},r=t,Object.assign(a,r),i=new KeyboardEvent("keyup",n),dispatchEvent(i)},I=function(e,t){var n,i,a,r;null==t&&(t="solid 2px #07d"),e&&(C.includes(e)||(n=e.style,i=n.outline,a=n.outlineOffset,(r=e.style).outline=t,r.outlineOffset="-1px",C.push(e),setTimeout(function(){var t;(t=e.style).outline=i,t.outlineOffset=a,C.splice(C.indexOf(e),1)},400)))},$=function(e){null==e&&(e=R),null!=e&&e.parentElement.querySelectorAll("ul").forEach(function(e){return e.hidden=!0})},H=function(e){null==e&&(e=R),null!=e&&e.parentElement.querySelectorAll("ul").forEach(function(e){return e.hidden=!1})},O=function(e){var t,n,i,a,r,o,c,l,s,u;if(null==e&&(e=R),e)if(i=(t=e.parentElement)[n="$_taxon_toggleSanitizeLis_innerHTML"])t.innerHTML=i,delete t[n];else{for(t[n]=t.innerHTML,a=0,o=(r=t.children).length;a<o;++a)c=r[a],l=S.test(c.innerText),(s=c.querySelector("small"))&&s.remove(),u=(i=c.querySelector("i"))?i.innerText:c.innerText,l&&(u+=" †"),c.innerText=u;B(t)}},B=function(e){var t,n,i,a;e&&(document.activeElement.blur(),(t=document.body.createTextRange)?((n=i=t()).moveToElementText(e),n.select()):getSelection?((i=document.createRange()).selectNodeContents(e),(a=s).removeAllRanges(),a.addRange(i)):console.warn("Trình duyệt không hỗ trợ Selection."))},U=function(e,t){var n,i;null==t&&(t=5e3),(n=i=document.createElement("div")).className="taxonNotify",n.innerHTML=e,document.body.appendChild(i),setTimeout(function(){i.remove()},t)},P=function(){return open("https://api.imgur.com/oauth2/authorize?client_id=92ac14aabe20918&response_type=token&state=taxon","_blank")},W=async function(e){var n;o&&(o.destroy(),o=null),i?(document.querySelector(".hm60ue"),3===(n=document.querySelectorAll(".VSIspc")).length&&n[1].remove(),3===(n=document.querySelectorAll(".ZGGHx")).length&&n[1].remove(),(e=(e=document.querySelectorAll(".n3VNCb"))[3===e.length?1:0]).parentElement.href="javascript:",e.src=await(await fetch("http://localhost:8080/q/img/"+e.src)).text()):t&&document.querySelector(".mw-mmv-download-dialog"),e&&(o=new Cropper(e,{checkCrossOrigin:!1,zoomable:!1,guides:!1,center:!1,ready:function(){this.cropper.setCropBoxData({left:0,top:0,width:0,height:0})}}))},V=async function(e,t){var n,i,a,r,s,u,d;i=(n=null!=e?e:{}).image,a=n.type,c=!0,l?(U("Đang upload ảnh imgur..."),(r=s=new FormData).append("image",i),r.append("album","RPTWQrk"),r.append("type",a),(u=await fetch("https://api.imgur.com/3/image",{method:"post",headers:{Authorization:"Bearer "+l},body:s})).ok?200===(u=await u.json()).status?(o&&(o.destroy(),o=null),await _(" # "+u.data.id),location.href="https://imgur.com/edit?deletehash="+u.data.deletehash+"&album_id=RPTWQrk"):d=Error("Lấy thông tin ảnh imgur thất bại"):d=Error("Upload ảnh imgur thất bại")):d=Error("Chưa có token"),d&&U(d.message),c=!1,"function"==typeof t&&t(d,u.data)},F=function(){chrome.runtime.sendMessage("closeTab")},window.addEventListener("keydown",function(e){e.repeat||E.test(e.code)||(a=e.code)}),window.addEventListener("keyup",async function(e){var l,s,d,h,y,g,b,v,k,x,q,C,R,G,X,Y,ee,te,ne,ie,ae,re,oe,ce,le,se,ue,de,me,pe,he,ye,fe,ge,be,ve,ke,Ke,xe,we=async function(){switch(a){case"KeyP":return q.match(L);case"Semicolon":return q.match(T);case"KeyL":return q.match(A);default:return q.match(/^[A-Z][a-z]+/)}};if(u?(a=void 0,u=!1):e.isTrusted||E.test(e.code)||(a=e.code),l=e.ctrlKey,s=e.shiftKey,d=e.altKey,h=e.metaKey,y=!(l||s||d||h),l&&!s&&!d&&!h,g=!l&&s&&!d&&!h,!l&&!s&&d&&!h,!l&&!s&&!d&&h,t&&(b="Semicolon"===a||f.some(function(e){return e[1]===a}),e.shiftKey&&b&&$()),Z=(getSelection()+"").trim(),j()){if(t){if(Z){if(!e.ctrlKey&&document.activeElement===document.body){if(b){if(v=function(e){var t;return null==e&&(e=""),(e=e.trim()).match(S)?(e=e.replace(S,""),t=!0):t=!1,[e=(e=e.trim().replace(w,"")).replace(/^"(.+)"$/,"$1"),t]},r="",k=Z.split(z),x=void 0,!e.isTrusted&&(q=v(k[0])[0])&&("KeyL"===a||"KeyP"===a||"Semicolon"===a))switch(!1){case!(C=f.find(function(e){var t;return null!=(t=e[7])?t.test(q):void 0})):x=C[4];break;case!/^([A-Z]\.\s?[a-z]\.\s[a-z-]+|[A-Z][a-z]+\s[a-z]+\s[a-z-]+)/.test(q):a="KeyP"}for(null!=x?a="":(x=f.findIndex(function(e){return e[1]===a}))<0&&(x=0),R="\t".repeat((xe=x)<0?0:xe),G=0,X=k.length;G<X;++G)Y=G,ee=v(q=k[G]),q=ee[0],te=ee[1],ne=await we(),console.log(ne),ne&&(ne=ne[0],te&&(ne+="*"),ne=R+ne),q=ne,k[Y]=q;k=k.filter(Boolean),k=J(k.filter(function(e){return!e.includes("*")})).concat(J(k.filter(function(e){return e.includes("*")}))),N(k),r=("\n"+(r+=Q.call(k,"\n"))).replace(/[\r\n]?\t*\bnull\b/g,"").replace(/\ /g," "),e.isTrusted||"KeyL"===a&&(r.trim()||(q=v(k[0])[0],(C=f.find(function(e){var t;return null!=(t=e[7])?t.test(q):void 0}))?M(C[1]):M("KeyC")))}else switch(a){case"KeyQ":y&&(Z=Z.replace(w,""),r=" # "+Z.charAt(0).toUpperCase()+Z.slice(1));break;case"Delete":y&&$();break;case"Backspace":y&&O()}r&&_(r)}}else switch(a){case"KeyC":y&&(p?p.click():document.URL.includes("commons.wikimedia.org")&&history.back());break;case"KeyS":y&&((ie=document.querySelector(".wb-otherproject-species> a"))?ie.click():document.URL.includes("species.wikimedia.org")&&history.back());break;case"KeyD":y&&(C=(ae=function(e){return document.querySelector("a.interlanguage-link-target[hreflang="+e+"]")})("vi")||ae("en"))&&C.click()}switch(a){case"KeyE":y&&r&&(r.includes("*")?r=r.replace(/\*/g,""):(r=r.replace(/([^*])\n/g,"$1*\n")).endsWith("*")||(r+="*"),_(r));break;case"KeyW":y&&F();break;case"F1":y&&(e.preventDefault(),re=f.map(function(e){return e[0].split("|").join(" | ")+e[1]}).join(": "),alert(re));break;case"KeyA":y&&(D=!D);break;case"Backquote":y&&(z=K[1]);break;case"KeyV":if(y)if(oe=document.querySelector("h2> #Species, h3> #Species")){for(oe=oe.parentElement;(oe=oe.nextElementSibling)&&"ul"!==oe.localName;)if(ce=oe.querySelector("ul")){oe=ce;break}oe&&(B(oe),M("KeyL"),I(oe))}else(oe=document.querySelector("table.infobox.biota .species"))&&(B(oe),M("KeyL"),I(oe));break;case"Digit2":case"Digit3":if(y&&(le=document.querySelectorAll(".mw-parser-output> h"+a[5]))){for(re="",G=0,X=le.length;G<X;++G){ue=se=le[G];do{ue=ue.nextElementSibling}while("ul"!==ue.localName);for(re+="\n"+"\t".repeat(29)+/[A-Z][a-z]+/.exec(se.innerText)[0],de=0,me=(ee=ue.children).length;de<me;++de)if(he=(pe=ee[de]).querySelector("i").innerText.split(" ")[1],re+="\n"+"\t".repeat(34)+he,ye=pe.querySelector("ul"))for(re+="\n"+"\t".repeat(35)+he,fe=0,be=(ge=ye.children).length;fe<be;++fe)he!==(ve=ge[fe].querySelector("i").innerText.split(" ")[2])&&(re+="\n"+"\t".repeat(35)+ve)}_(re)}break;case"Digit4":if(y&&(oe=document.querySelector(".mw-parser-output> h2"))){re="";do{switch(oe.localName){case"h2":re+="\n"+"\t".repeat(25)+/[A-Z][a-z]+/.exec(oe.innerText)[0];break;case"h3":re+="\n"+"\t".repeat(27)+/[A-Z][a-z]+/.exec(oe.innerText)[0];break;case"ul":for(G=0,X=(ee=oe.children).length;G<X;++G)pe=ee[G],re+="\n"+"\t".repeat(29)+/[A-Z][a-z]+/.exec(pe.innerText)[0]}}while(oe=oe.nextElementSibling);_(re)}break;case"KeyO":ie="https://en.wikipedia.org/wiki/"+(re=await navigator.clipboard.readText()),g?open(ie):location.href=ie}g&&H()}else if(n)if("/edit"===location.pathname)switch(a){case"KeyS":y&&document.querySelector("#save").click();break;case"KeyR":y&&document.querySelector("#reset-crop").click()}else switch(a){case"KeyE":y&&document.querySelector(".post-image-option.help>a").click()}switch(a){case"KeyN":i&&y&&W();break;case"KeyM":c||y&&(document.contains(null!=o?o.element:void 0)?(ke=(ke=o.getCroppedCanvas().toDataURL("image/jpeg")).replace("data:image/jpeg;base64,",""),Ke="base64"):i&&(ke=document.querySelectorAll(".n3VNCb")[1].src,Ke="URL"),ke?V({image:ke,type:Ke}):U("Không có ảnh nào được chọn"));break;case"KeyK":y&&confirm("Lấy token imgur mới?")&&P();break;case"Escape":o&&y&&(o.destroy(),o=null);break;case"KeyZ":y&&(Z?_(Z):history.back());break;case"KeyX":y&&history.forward();break;case"KeyW":y&&F()}}E.test(a)||(a=void 0),0}),window.addEventListener("mousedown",function(e){var r,o,l,s,d,p,h,g,b,v,k,K,x,w,S,E,z,L,T,A;if(R=null,Z=(getSelection()+"").trim(),e.buttons,o=(r=e.target).localName,j())switch(e.which){case 3:switch(!1){case!n:"img"===o&&((l=document.createElement("a")).href=r.src,s=l.pathname.slice(1,8),e.altKey?_(s):(d=e.shiftKey?" | ":" # ",_(d+s)),I(r));break;case!i:"img"===o&&(e.ctrlKey||(_(r.src),I(r)));break;case!t:switch(!1){case"img"!==o:switch(a){case"KeyN":W(r),u=!0;break;case"KeyM":c||V({image:r.src,type:"URL"}),u=!0;break;default:if(!e.ctrlKey){if(p=r.src,e.altKey)_(p);else{switch(!1){case!/\/\d+px-.+/.test(p):p=p.replace("https://upload.wikimedia.org/wikipedia/commons/thumb","").replace(/\/\d+px-.+/,"");break;case!/-\d+px-.+/.test(p):p=p.replace(/-\d+px-/,"-220px-")}d=e.shiftKey?" | ":" # ",(h={KeyF:"fossil",KeyR:"restoration",KeyC:"reconstruction",KeyE:"exhibit",KeyD:"drawing",KeyH:"holotype",KeyS:"skull",KeyK:"skeleton",KeyJ:"jaw",KeyM:"mandible",KeyI:"illustration",KeyP:"specimen"}[a]||"")&&(h=" ; "+h,u=!0),_(d+p+h)}I(r)}}break;case!(g=r.closest(q)):b=f.find(function(e){return e[2]===g.className})[1],B(r),M(b),I(r);break;case!Z:M("KeyL");break;case"li"!==o:e.altKey?y=["altLis",r]:($(r),((v=r.parentElement).$_taxon_toggleSanitizeLis_innerHTML||r.querySelector(":scope> a ~ i"))&&O(r),B(r.parentElement),M(b="KeyL"),I(r.parentElement));break;case!r.closest(".infobox.biota"):e.altKey?y=["altLisInfoboxBiota",r]:(k=r.closest("a:not(.selflink)"))?y=["aInfoboxBiota",k]:(b="KeyL",(K=r.closest("td"))&&(w=null!=(x=K.previousElementSibling)?x.innerText.trim().toLowerCase().replace(/[^a-z]/g,""):void 0)&&(S=f.find(function(e){return e[6].test(w)}))&&(b=S[1]),(E=K.querySelector("a"))&&(K=E),B(K),M(b),I(K));break;case!(("th"===o||"td"===o)&&(z=r.closest("table"))):e.ctrlKey||(L=e.shiftKey?J(z.rows).filter(function(e){var t,n,i,a;if((t=J(e.cells)).every(function(e){return"th"===e.localName}))return!1;for(n=0,i=t.length;n<i;++n)(a=t[n]).rowSpan>1&&a.remove();return!0}).map(function(e){return e.cells[r.cellIndex]}):J(z.rows).slice(r.parentElement.rowIndex).map(function(e){return e.cells[r.cellIndex]}),(T=v=document.createElement("ul")).className="pointer-events-none",T.innerHTML=L.map(function(e){return"<li>"+e.innerHTML+"</li>"}).join(""),z.replaceWith(v),B(v),M(a||"KeyL"),I(v));break;case!(A=r.closest("#firstHeading,b,h1,h2,h3,h4,h5,h6")):B(A),M("KeyQ"),I(A)}break;default:switch(!1){case"img"!==o:switch(a){case"KeyN":W(r),u=!0;break;case"KeyM":c||V({image:r.src,type:"URL"}),u=!0}}}}},!0),window.addEventListener("mouseup",function(e){var i,r,o,c,l,s,u,d,p,h,f,g,b,v;switch(R=null,r=(i=e.target).localName,e.which){case 1:switch(!1){case!t:1===e.detail&&(/^(li|a|b|i)$/.test(r)||"p"===r&&i.closest(".infobox.biota"))&&(e.altKey||D&&("a"!==r||"a"===r&&!i.href)&&(B(i.parentElement),R=i));break;case!n:1===e.detail&&"img"===r&&i.closest(".post-image-container").querySelector(".post-image-option.help>a").click()}break;case 3:if(t){if(y){switch(o=y[0],c=G.call(y,1),o){case"altLis":for(s="$_taxon_linkOpened",u=0,d=!1,p=0,f=(h=(l=c[0]).parentElement.children).length;p<f&&((g=h[p])[s]||(g[s]=!0,!(b=g.querySelector(":scope> i> a:not(.new), :scope> a:not(.new)"))||(b.style.textDecoration="underline",e.shiftKey||(d=!0,open(b.href)),10!=++u)));++p);u||I(l.parentElement,"solid 2px #f43"),d&&chrome.extension.sendMessage("openTabs");break;case"altLisInfoboxBiota":for(s="$_taxon_linkOpened",u=0,d=!1,p=0,f=(h=(l=c[0]).children).length;p<f&&((g=h[p])[s]||(g[s]=!0,!(b=g.querySelector(":scope> a:not(.new)"))||(b.style.textDecoration="underline",e.shiftKey||(d=!0,open(b.href)),10!=++u)));++p);u||I(l,"solid 2px #f43"),d&&chrome.extension.sendMessage("openTabs");break;case"aInfoboxBiota":b=c[0],open(b.href)}y=null}else"a"!==r||i.classList.contains("selflink")||(i.style.textDecoration="underline",open(i.href));(v=document.querySelector("ul.pointer-events-none"))&&v.classList.remove("pointer-events-none")}}a||0},!0),window.addEventListener("contextmenu",function(e){e.x&&e.preventDefault()},!0),n||chrome.storage.local.get(["token","tokenTime"],function(e){var t,n,i;l=e.token,t=e.tokenTime,l&&t+6048e5>Date.now()||(n=P(),i=setInterval(function(){n.closed&&(clearInterval(i),chrome.storage.local.get(["token"],function(e){l=e.token}))},1e3))}),window.addEventListener("DOMContentLoaded",async function(){var e,i,a,r,o;switch(!1){case!t:if(e=document.querySelector("#References")){e=e.parentElement;do{i=e.nextElementSibling,e.remove()}while(e=i)}(e=document.querySelector(".infobox.biota img"))&&((new Image).src=e.src.replace(/\/\d{3}px-/,"/800px-")),(d=document.querySelector("a.interlanguage-link-target[hreflang=vi]"))&&(a=/[^\/]+$/.exec(d.href)[0]),(p=document.querySelector(".wb-otherproject-commons> a"))&&((e=document.createElement("link")).rel="prerender",e.href=p.href,document.head.appendChild(e)),h=content.innerText.includes("subspecies"),a&&(r=await(await fetch("https://vi.wikipedia.org/api/rest_v1/page/summary/"+a)).json()),o=m.bind({view:function(){var e,t;return m(".column.taxonRightSide",m(".row-2.p-3",h?m(".text-green","Phân loài"):void 0,p?m(".text-green","Wiki common"):void 0),r?m(".col.px-3.column.f-center.scroll-y",m(".mt-1.mb-3.taxonSummaryTitle",m("b",r.title)),(t=null!=(e=r.thumbnail)?e.source:void 0)?m("img.taxonSummaryImg",{src:t}):m("p.text-red.text-center","Không có hình ảnh"),m("p.taxonSummaryExtract",m.trust(r.extract_html))):m(".col.text-red.text-center","Không có tiếng Việt"))}}),e=document.createElement("div"),document.body.appendChild(e),m.mount(e,o);break;case!n:"?state=taxon"===location.search&&(l=/access_token=([a-z0-9]+)/.exec(location.hash)[1],chrome.storage.local.set({token:l,tokenTime:Date.now()},F))}})}).call(this);