(async function(){var e,t,n,i,r,a,o,c,s,l,u,d,p,h,y,f,g,b,v,k,w,K,x,S,E,T,z,A,L,q,Z,R,C,D,N,j,I,_,M,$,B,H,O,U,P,G,W,F,V=[].join,Q=[].slice,J=Array.from||function(e){return Q.call(e)};for(e=location.hostname,t=/\bwiki[mp]edia\b/.test(e),n=/\.wikipedia\.org$/.test(e),i=/\bimgur\b/.test(e),r=/\bgoogle\b/.test(e),a=void 0,0,o="",c=null,s=!1,l="",u=getSelection(),d=!1,p=null,h=null,y=!1,f=null,b=0,v=(g=[["vực|siêu giới|domain|super-?kingdom","","",void 0],["giới|kingdom","","",void 0],["phân giới|sub-?kingdom","","",void 0],["thứ giới|infra-?kingdom","","",void 0],["liên ngành|siêu ngành|super-?phylum","","",void 0],["ngành|phylum","KeyN","phylum",void 0],["phân ngành|sub-?phylum","","",void 0],["thứ ngành|infra-?phylum","","",void 0],["tiểu ngành|micro-?phylum","","",void 0],["liên lớp|siêu lớp|super-?class","KeyS","superclass",void 0],["lớp|class","KeyX","class",void 0],["phân lớp|sub-?class","KeyD","subclass",void 0],["thứ lớp|infra-?class","","",void 0],["tiểu lớp|parv-?class","","",void 0],["đoàn|legion","","",void 0],["liên đội|super-?cohort","","",void 0],["đội|cohort","","",void 0],["tổng bộ|đại bộ|magn-?order","","",void 0],["liên bộ|siêu bộ|super-?order","KeyG","superorder",void 0],["bộ|order","KeyB","order",void 0],["phân bộ|sub-?order","KeyJ","suborder",void 0],["thứ bộ|infra-?order","","",void 0],["tiểu bộ|parv-?order","","",void 0],["liên họ|siêu họ|super-?family","KeyY","superfamily","oidea"],["họ|family","KeyH","family","idae"],["phân họ|sub-?family","KeyU","subfamily","inae"],["liên tông|super-?tribe","Digit5","supertribe",void 0],["tông|tribe","KeyT","tribe","ini"],["phân tông|sub-?tribe","Digit6","subtribe",void 0],["chi|genus","KeyC","genus",void 0],["phân chi|sub-?genus","KeyF","subgenus",void 0],["mục|section","","",void 0],["loạt|series","","",void 0],["liên loài|super-?species","","",void 0],["loài|species","KeyL","species",void 0],["phân loài|sub-?species","KeyP","subspecies",void 0],["thứ|variety","","",void 0],["dạng|form","","",void 0]]).length;b<v;++b)k=b,(w=g[b])[4]=k,w[5]=RegExp("^(?:"+w[0]+"):?\\s+","i"),w[6]=RegExp("^(?:"+w[0]+")$","i"),w[7]=w[3]&&RegExp("^[A-Z][a-z]"+w[3]+"$");K=[/[\r\n]+/,/[\r\n]+|\s–\s|\s\-\s/],x=g.map(function(e){return e[0]}).join("|"),S=RegExp("^(?:"+x+"):?\\s+","i"),E=/\b(?:tuyệt chủng|extinct|fossil)\b|†/i,T=K[+("species.wikimedia.org"===e)],z=/(?<=^[A-Z]\.\s*[a-z-]+\s)[a-z-]+|(?<=^[A-Z]\.\s*[-a-z]\.\s*)[-a-z]+|(?<=^[A-Z][a-z]+\s[-a-z]+\s)[-a-z]+|(?<=^[A-Z][a-z]+\s[-a-z]\.\s*)[-a-z]+/,A=/(?<=^[A-Z]\.\s*[a-z]\.\s*)[a-zA-Z0-9]+\s[-a-zA-Z0-9]+|(?<=^[A-Z][a-z]+\s[-a-z]+\s)[a-zA-Z0-9]+\s[-a-zA-Z0-9]+|(?<=^[A-Z]\.\s*[a-z]\.\s*)[-a-zA-Z0-9.\/]+|(?<=^[A-Z][a-z]+\s[a-z\-]+\s)[a-zA-Z0-9\-\/\.]+/,L=/(?<=^[A-Z]\.\s*)[-a-z]+|(?<=^[A-Z][a-z]+\s)[-a-z]+/,q=g.filter(function(e){return e[2]}).map(function(e){return"."+e[2]}).join(","),o="",Z="",R=[],C=null,D=!0,m.class=function(...e){var t,n,i,r,a,o;for(t=[],n=0,r=(i=e).length;n<r;++n)if(a=i[n],Array.isArray(a))t.push(m.class.apply(m,a));else if(a instanceof Object)for(o in a)a[o]&&t.push(o);else null!=a&&t.push(a);return V.call(t," ")},m.bind=function(e,t){var n,i;for(n in null==t&&(t=e),e)"function"!=typeof(i=e[n])||/(bound|class) /.test(i.name)||(e[n]=i.bind(t));return e},N=function(e){var t,n,i,r;for(t=[],n=0,i=e.length;n<i;++n)r=e[n],t.includes(r)||t.push(r);return e.splice.apply(e,[0,e.length].concat(J(t))),e},j=function(e){if(null!=e)return u.empty(),navigator.clipboard.writeText(e)},I=function(e){var t,n,i,r;document.activeElement.blur(),(t=document.body.createTextRange)?((n=i=t()).moveToElementText(e),n.select()):getSelection?((i=document.createRange()).selectNodeContents(e),(r=u).removeAllRanges(),r.addRange(i)):console.warn("Trình duyệt không hỗ trợ Selection.")},_=function(){return!/^(?:input|textarea)$/.test(document.activeElement.localName)},M=function(e,t){var n,i,r,a;r=n={code:e},a=t,Object.assign(r,a),i=new KeyboardEvent("keypress",n),dispatchEvent(i)},$=function(e,t){var n,i,r,a;null==t&&(t="solid 2px #07d"),R.includes(e)||(n=e.style,i=n.outline,r=n.outlineOffset,(a=e.style).outline=t,a.outlineOffset="-1px",R.push(e),setTimeout(function(){var t;(t=e.style).outline=i,t.outlineOffset=r,R.splice(R.indexOf(e),1)},400))},B=function(e){null==e&&(e=C),null!=e&&e.parentElement.querySelectorAll("ul").forEach(function(e){return e.hidden=!0})},H=function(e){null==e&&(e=C),null!=e&&e.parentElement.querySelectorAll("ul").forEach(function(e){return e.hidden=!1})},O=function(e){var t,n,i,r,a,o,c,s;if(null==e&&(e=C),e)if(i=(t=e.parentElement)[n="$_Taxonomy_keepITagUl_innerHTML"])t.innerHTML=i,delete t[n];else{for(t[n]=t.innerHTML,r=0,o=(a=t.children).length;r<o;++r)s=(c=a[r]).querySelector("i").innerText,E.test(c.innerText)&&(s+=" †"),c.innerText=s;I(t)}},U=function(e,t){var n,i;null==t&&(t=5e3),(n=i=document.createElement("div")).className="taxonNotify",n.innerHTML=e,document.body.appendChild(i),setTimeout(function(){i.remove()},t)},P=function(){return open("https://api.imgur.com/oauth2/authorize?client_id=92ac14aabe20918&response_type=token&state=taxon","_blank")},G=async function(e){var n,i;c&&(c.destroy(),c=null),r?(document.querySelector(".hm60ue"),3===(n=document.querySelectorAll(".VSIspc")).length&&n[1].remove(),3===(n=document.querySelectorAll(".ZGGHx")).length&&n[1].remove(),(e=(e=document.querySelectorAll(".n3VNCb"))[3===e.length?1:0]).parentElement.href="javascript:",i=await(await fetch("https://cors-anywhere.herokuapp.com/"+e.src)).blob(),e.src=await new Promise(function(e){var t;(t=new FileReader).onload=function(t){e(t.target.result)},t.readAsDataURL(i)})):t&&document.querySelector(".mw-mmv-download-dialog"),e&&(c=new Cropper(e,{checkCrossOrigin:!1,zoomable:!1,guides:!1,center:!1,ready:function(){this.cropper.setCropBoxData({left:0,top:0,width:0,height:0})}}))},W=async function(e,t){var n,i,r,a,o,u,d;i=(n=null!=e?e:{}).image,r=n.type,s=!0,l?(U("Đang upload ảnh imgur..."),(a=o=new FormData).append("image",i),a.append("album","RPTWQrk"),a.append("type",r),(u=await fetch("https://api.imgur.com/3/image",{method:"post",headers:{Authorization:"Bearer "+l},body:o})).ok?200===(u=await u.json()).status?(c&&(c.destroy(),c=null),await j(" # "+u.data.id),location.href="https://imgur.com/edit?deletehash="+u.data.deletehash+"&album_id=RPTWQrk"):d=Error("Lấy thông tin ảnh imgur thất bại"):d=Error("Upload ảnh imgur thất bại")):d=Error("Chưa có token"),d&&U(d.message),s=!1,"function"==typeof t&&t(d,u.data)},F=function(){chrome.runtime.sendMessage("closeTab")},window.addEventListener("keydown",function(e){e.repeat||(a=e.code)}),window.addEventListener("keypress",async function(e){var n,l,u,m,p,y,f,b,v,k,w,x,q,R,C,U,Q,X,Y,ee,te,ne,ie,re,ae,oe,ce,se,le,ue,de,me,pe,he,ye,fe,ge,be,ve=async function(){switch(a){case"KeyP":return k.match(z);case"Semicolon":return k.match(A);case"KeyL":return k.match(L);default:return k.match(/^[A-Z][a-z]+/)}};if(d?(a=void 0,d=!1):e.isTrusted||(a=e.code),n=e.ctrlKey,l=e.shiftKey,u=e.altKey,m=e.metaKey,p=!(n||l||u||m),n&&!l&&!u&&!m,y=!n&&l&&!u&&!m,!n&&!l&&u&&!m,!n&&!l&&!u&&m,t&&(f="Semicolon"===a||g.some(function(e){return e[1]===a}),e.shiftKey&&f&&B()),Z=(getSelection()+"").trim(),_()){if(t){if(Z){if(!e.ctrlKey&&document.activeElement===document.body){if(f){if(o="",b=Z.split(T),v=void 0,!e.isTrusted&&(k=b[0])&&("KeyL"===a||"KeyP"===a||"Semicolon"===a))switch(!1){case!(w=g.find(function(e){return e[5].test(k)})):v=w[4];break;case!/^([A-Z]\.\s?[a-z]\.\s[a-z-]{2,}|[A-Z][a-z]+\s[a-z]{2,}\s[a-z-]{2,})/.test(k):a="KeyP"}for(null!=v?a="":(v=g.findIndex(function(e){return e[1]===a}))<0&&(v=0),x="\t".repeat((be=v)<0?0:be),q=0,R=b.length;q<R;++q)C=q,(k=(k=b[q]).trim()).match(E)?(k=k.replace(E,""),U=!0):U=!1,k=(k=k.trim().replace(S,"")).replace(/^"(.+)"$/,"$1"),(Q=await ve())&&(Q=Q[0],U&&(Q+="*"),Q=x+Q),k=Q,b[C]=k;b=b.filter(Boolean),b=J(b.filter(function(e){return!e.includes("*")})).concat(J(b.filter(function(e){return e.includes("*")}))),N(b),o=("\n"+(o+=V.call(b,"\n"))).replace(/[\r\n]?\t*\bnull\b/g,"").replace(/\ /g," "),e.isTrusted||"KeyL"===a&&(o.trim()||(k=b[0],(w=g.find(function(e){var t;return null!=(t=e[7])?t.test(k):void 0}))?M(w[1]):M("KeyC")))}else switch(a){case"KeyQ":p&&(Z=Z.replace(S,""),o=" # "+Z.charAt(0).toUpperCase()+Z.slice(1));break;case"Delete":p&&B();break;case"Backspace":p&&O();break;case"KeyZ":p&&(o=Z)}o&&j(o)}}else switch(a){case"KeyZ":p&&history.back();break;case"KeyX":p&&history.forward();break;case"KeyC":p&&(h?h.click():document.URL.includes("commons.wikimedia.org")&&history.back());break;case"KeyS":p&&((X=document.querySelector(".wb-otherproject-species> a"))?X.click():document.URL.includes("species.wikimedia.org")&&history.back());break;case"KeyD":p&&(w=(Y=function(e){return document.querySelector("a.interlanguage-link-target[hreflang="+e+"]")})("vi")||Y("en"))&&w.click()}switch(a){case"KeyE":p&&o&&(o.includes("*")?o=o.replace(/\*/g,""):(o=o.replace(/([^*])\n/g,"$1*\n")).endsWith("*")||(o+="*"),j(o));break;case"KeyW":p&&F();break;case"F1":p&&(e.preventDefault(),ee=g.map(function(e){return e[0].split("|").join(" | ")+e[1]}).join(": "),alert(ee));break;case"KeyA":p&&(D=!D);break;case"Backquote":p&&(T=K[1]);break;case"KeyV":if(p)if(te=document.querySelector("h2> #Species, h3> #Species")){for(te=te.parentElement;(te=te.nextElementSibling)&&"ul"!==te.localName;)if(ne=te.querySelector("ul")){te=ne;break}te&&(I(te),M("KeyL"),$(te))}else(te=document.querySelector("table.infobox.biota .species"))&&(I(te),M("KeyL"),$(te));break;case"Digit2":case"Digit3":if(p&&(ie=document.querySelectorAll(".mw-parser-output> h"+a[5]))){for(ee="",q=0,R=ie.length;q<R;++q){ae=re=ie[q];do{ae=ae.nextElementSibling}while("ul"!==ae.localName);for(ee+="\n"+"\t".repeat(29)+/[A-Z][a-z]+/.exec(re.innerText)[0],oe=0,se=(ce=ae.children).length;oe<se;++oe)if(ue=(le=ce[oe]).querySelector("i").innerText.split(" ")[1],ee+="\n"+"\t".repeat(34)+ue,de=le.querySelector("ul"))for(ee+="\n"+"\t".repeat(35)+ue,me=0,he=(pe=de.children).length;me<he;++me)ue!==(ye=pe[me].querySelector("i").innerText.split(" ")[2])&&(ee+="\n"+"\t".repeat(35)+ye)}j(ee)}break;case"Digit4":if(p&&(te=document.querySelector(".mw-parser-output> h2"))){ee="";do{switch(te.localName){case"h2":ee+="\n"+"\t".repeat(25)+/[A-Z][a-z]+/.exec(te.innerText)[0];break;case"h3":ee+="\n"+"\t".repeat(27)+/[A-Z][a-z]+/.exec(te.innerText)[0];break;case"ul":for(q=0,R=(ce=te.children).length;q<R;++q)le=ce[q],ee+="\n"+"\t".repeat(29)+/[A-Z][a-z]+/.exec(le.innerText)[0]}}while(te=te.nextElementSibling);j(ee)}break;case"KeyO":X="https://en.wikipedia.org/wiki/"+(ee=await navigator.clipboard.readText()),y?open(X):location.href=X}y&&H()}else if(i){if("/edit"===location.pathname)switch(a){case"KeyS":p&&document.querySelector("#save").click();break;case"KeyR":p&&document.querySelector("#reset-crop").click()}else switch(a){case"KeyE":p&&document.querySelector(".post-image-option.help>a").click()}switch(a){case"KeyZ":p&&history.back();break;case"KeyW":p&&F()}}switch(a){case"KeyN":r&&p&&G();break;case"KeyM":s||p&&(document.contains(null!=c?c.element:void 0)?(fe=(fe=c.getCroppedCanvas().toDataURL("image/jpeg")).replace("data:image/jpeg;base64,",""),ge="base64"):r&&(fe=document.querySelectorAll(".n3VNCb")[1].src,ge="URL"),fe&&W({image:fe,type:ge}));break;case"KeyK":p&&confirm("Lấy token imgur mới?")&&P();break;case"Escape":c&&p&&(c.destroy(),c=null)}}a=void 0,0}),window.addEventListener("mousedown",function(e){var n,o,c,l,u,m,p,h,y,b,v,k,w,K,x,S,E,T,z,A,L,R,D,N;if(C=null,Z=(getSelection()+"").trim(),e.buttons,o=(n=e.target).localName,_())switch(e.which){case 3:switch(!1){case!i:"img"===o&&((c=document.createElement("a")).href=n.src,l=c.pathname.slice(1,8),e.altKey?j(l):(m(e.shiftKey),j(m+l)),$(n));break;case!r:"img"===o&&(e.ctrlKey||(j(n.src),$(n)));break;case!t:switch(!1){case"img"!==o:switch(a){case"KeyN":G(n),d=!0;break;case"KeyM":s||W({image:n.src,type:"URL"}),d=!0;break;default:if(!e.ctrlKey){if(u=n.src,e.altKey)j(u);else{switch(!1){case!/\/\d+px-.+/.test(u):u=u.replace("https://upload.wikimedia.org/wikipedia/commons/thumb","").replace(/\/\d+px-.+/,"");break;case!/-\d+px-.+/.test(u):u=u.replace(/-\d+px-/,"-220px-")}m=e.shiftKey?" | ":" # ",(p={KeyF:"fossil",KeyR:"restoration",KeyC:"reconstruction",KeyE:"exhibit",KeyD:"drawing",KeyH:"holotype",KeyS:"skull",KeyK:"skeleton",KeyJ:"jaw",KeyM:"mandible",KeyI:"illustration",KeyP:"specimen"}[a]||"")&&(p=" ; "+p,d=!0),j(m+u+p)}$(n)}}break;case!(h=n.closest(q)):y=g.find(function(e){return e[2]===h.className})[1],I(n),M(y),$(n);break;case!Z:M("KeyL");break;case"li"!==o:e.altKey?f=["altLis",n]:(B(n),n.parentElement.firstElementChild.querySelector("i:first-child> a")||O(n),I(n.parentElement),y="KeyL",(b=n.closest(".infobox.biota")&&/Genus|Genera/.exec(n.closest("tr").previousElementSibling.innerText))||(k=null!=(v=n.parentElement)?v.previousElementSibling:void 0)&&(b=k.querySelector("#Genera")||(null!=(w=k.previousElementSibling)?w.querySelector("#Genera"):void 0)),b&&(y="KeyC"),M(y),$(n.parentElement));break;case!n.closest(".infobox.biota"):e.altKey?f=["altLisInfoboxBiota",n]:(K=n.closest("a:not(.selflink)"))?f=["aInfoboxBiota",K]:(y="KeyL",(x=n.closest("td"))&&(E=null!=(S=x.previousElementSibling)?S.innerText.trim().toLowerCase().replace(/[^a-z]/g,""):void 0)&&(T=g.find(function(e){return e[6].test(E)}))&&(y=T[1]),(z=x.querySelector("a"))&&(x=z),I(x),M(y),$(x));break;case!(("th"===o||"td"===o)&&(A=n.closest("table"))):e.ctrlKey||(L=e.shiftKey?J(A.rows).filter(function(e){var t,n,i,r;if((t=J(e.cells)).every(function(e){return"th"===e.localName}))return!1;for(n=0,i=t.length;n<i;++n)(r=t[n]).rowSpan>1&&r.remove();return!0}).map(function(e){return e.cells[n.cellIndex]}):J(A.rows).slice(n.parentElement.rowIndex).map(function(e){return e.cells[n.cellIndex]}),(R=D=document.createElement("ul")).className="pointer-events-none",R.innerHTML=L.map(function(e){return"<li>"+e.innerHTML+"</li>"}).join(""),A.replaceWith(D),I(D),M(a||"KeyL"),$(D));break;case!(N=n.closest("#firstHeading,b,h1,h2,h3,h4,h5,h6")):I(N),M("KeyQ"),$(N)}}}},!0),window.addEventListener("mouseup",function(e){var n,r,o,c,s,l,u,d,m,p,h,y,g,b;switch(C=null,r=(n=e.target).localName,e.which){case 1:switch(!1){case!t:1===e.detail&&(/^(li|a|b|i)$/.test(r)||"p"===r&&n.closest(".infobox.biota"))&&(e.altKey||D&&("a"!==r||"a"===r&&!n.href)&&(I(n.parentElement),C=n));break;case!i:1===e.detail&&"img"===r&&n.closest(".post-image-container").querySelector(".post-image-option.help>a").click()}break;case 3:if(t){if(f){switch(o=f[0],c=Q.call(f,1),o){case"altLis":for(l="$_Taxonomy_linkOpened",u=0,d=!1,m=0,h=(p=(s=c[0]).parentElement.children).length;m<h&&((y=p[m])[l]||(y[l]=!0,!(g=y.querySelector(":scope> i> a:not(.new), :scope> a:not(.new)"))||(g.style.textDecoration="underline",e.shiftKey||(d=!0,open(g.href)),10!=++u)));++m);u||$(s.parentElement,"solid 2px #f43"),d&&chrome.extension.sendMessage("openTabs");break;case"altLisInfoboxBiota":for(l="$_Taxonomy_linkOpened",u=0,d=!1,m=0,h=(p=(s=c[0]).children).length;m<h&&((y=p[m])[l]||(y[l]=!0,!(g=y.querySelector(":scope> a:not(.new)"))||(g.style.textDecoration="underline",e.shiftKey||(d=!0,open(g.href)),10!=++u)));++m);u||$(s,"solid 2px #f43"),d&&chrome.extension.sendMessage("openTabs");break;case"aInfoboxBiota":g=c[0],open(g.href)}f=null}else"a"!==r||n.classList.contains("selflink")||(n.style.textDecoration="underline",open(n.href));(b=document.querySelector("ul.pointer-events-none"))&&b.classList.remove("pointer-events-none")}}a||0},!0),window.addEventListener("contextmenu",function(e){e.x&&e.preventDefault()},!0),i||chrome.storage.sync.get(["token","tokenTime"],function(e){var t,n,i;l=e.token,t=e.tokenTime,l&&t+6048e5>Date.now()||(n=P(),i=setInterval(function(){n.closed&&(clearInterval(i),chrome.storage.sync.get(["token"],function(e){l=e.token}))},1e3))}),window.addEventListener("load",async function(){var e,r,a,o,c;switch(!1){case!t:if(n){if(e=document.querySelector("#References")){e=e.parentElement;do{r=e.nextElementSibling,e.remove()}while(e=r)}(p=document.querySelector("a.interlanguage-link-target[hreflang=vi]"))&&(a=/[^\/]+$/.exec(p.href)[0]),(h=document.querySelector(".wb-otherproject-commons> a"))&&((e=document.createElement("link")).rel="prerender",e.href=h.href,document.head.appendChild(e)),y=content.innerText.includes("subspecies"),a&&(o=await(await fetch("https://vi.wikipedia.org/api/rest_v1/page/summary/"+a)).json()),c=m.bind({view:function(){var e,t;return m(".column.taxonRightSide",m(".row-2.p-3",y?m(".text-green","Phân loài"):void 0,h?m(".text-green","Wiki common"):void 0),o?m(".col.px-3.column.f-center.scroll-y",m(".mt-1.mb-3.taxonSummaryTitle",m("b",o.title)),(t=null!=(e=o.thumbnail)?e.source:void 0)?m("img.taxonSummaryImg",{src:t}):m("p.text-red.text-center","Không có hình ảnh"),m("p.taxonSummaryExtract",m.trust(o.extract_html))):m(".col.text-red.text-center","Không có tiếng Việt"))}}),e=document.createElement("div"),document.body.appendChild(e),m.mount(e,c)}break;case!i:"?state=taxon"===location.search&&(l=/access_token=([a-z0-9]+)/.exec(location.hash)[1],chrome.storage.sync.set({token:l,tokenTime:Date.now()},F))}})}).call(this);