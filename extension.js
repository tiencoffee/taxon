(async function(){var e,t,n,r,a,i,o,c,s,l,u,p,d,h,y,f,g,b,k,K,w,v,x,S,E,z,L,A,q,T,C,Z,R,D,N,j,_,M,$,H,I,U,P,O,G,B,W,F=[].slice,Q=Array.from||function(e){return F.call(e)},V=[].join;for(e=location.hostname,t=/\bwiki[mp]edia\b/.test(e),n=/\.wikipedia\.org$/.test(e),r=/\bimgur\b/.test(e),a=/\bgoogle\b/.test(e),i=void 0,0,o="",c=null,s=!1,l="",u=getSelection(),p=!1,d=null,h=null,f=0,g=(y=[["vực|siêu giới|domain|super-?kingdom","",""],["giới|kingdom","",""],["phân giới|sub-?kingdom","",""],["thứ giới|infra-?kingdom","",""],["liên ngành|siêu ngành|super-?phylum","",""],["ngành|phylum","KeyN","phylum"],["phân ngành|sub-?phylum","",""],["thứ ngành|infra-?phylum","",""],["tiểu ngành|micro-?phylum","",""],["liên lớp|siêu lớp|super-?class","KeyS","superclass"],["lớp|class","KeyX","class"],["phân lớp|sub-?class","KeyD","subclass"],["thứ lớp|infra-?class","",""],["tiểu lớp|parv-?class","",""],["đoàn|legion","",""],["liên đội|super-?cohort","",""],["đội|cohort","",""],["tổng bộ|đại bộ|magn-?order","",""],["liên bộ|siêu bộ|super-?order","KeyG","superorder"],["bộ|order","KeyB","order"],["phân bộ|sub-?order","KeyJ","suborder"],["thứ bộ|infra-?order","",""],["tiểu bộ|parv-?order","",""],["liên họ|siêu họ|super-?family","KeyY","superfamily"],["họ|family","KeyH","family"],["phân họ|sub-?family","KeyU","subfamily"],["liên tông|super-?tribe","Digit5","supertribe"],["tông|tribe","KeyT","tribe"],["phân tông|sub-?tribe","Digit6","subtribe"],["chi|genus","KeyC","genus"],["phân chi|sub-?genus","KeyF","subgenus"],["mục|section","",""],["loạt|series","",""],["liên loài|super-?species","",""],["loài|species","KeyL","species"],["phân loài|sub-?species","KeyP","subspecies"],["thứ|variety","",""],["dạng|form","",""]]).length;f<g;++f)b=f,(k=y[f])[3]=b,k[4]=RegExp("^(?:"+k[0]+"):?\\s+","i"),k[5]=RegExp("^(?:"+k[0]+")$","i");K=[/[\r\n]+/,/[\r\n]+|\s–\s|\s\-\s/],w=y.map(function(e){return e[0]}).join("|"),v=RegExp("^(?:"+w+"):?\\s+","i"),x=/\b(?:tuyệt chủng|extinct|fossil)\b|†/i,S=/(Control|Shift|Alt|Meta)(Left|Right)|(Caps|Num)Lock|Tab/,E=K[+("species.wikimedia.org"===e)],z=/(?<=^[A-Z]\.\s*[a-z-]+\s)[a-z-]+|(?<=^[A-Z]\.\s*[-a-z]\.\s*)[-a-z]+|(?<=^[A-Z][a-z]+\s[-a-z]+\s)[-a-z]+|(?<=^[A-Z][a-z]+\s[-a-z]\.\s*)[-a-z]+/,L=/(?<=^[A-Z]\.\s*[a-z]\.\s*)[a-zA-Z0-9]+\s[-a-zA-Z0-9]+|(?<=^[A-Z][a-z]+\s[-a-z]+\s)[a-zA-Z0-9]+\s[-a-zA-Z0-9]+|(?<=^[A-Z]\.\s*[a-z]\.\s*)[-a-zA-Z0-9.\/]+|(?<=^[A-Z][a-z]+\s[a-z\-]+\s)[a-zA-Z0-9\-\/\.]+/,A=/(?<=^[A-Z]\.\s*)[-a-z]+|(?<=^[A-Z][a-z]+\s)[-a-z]+/,q=y.filter(function(e){return e[2]}).map(function(e){return"."+e[2]}).join(","),o="",T="",C=[],Z=null,R=!0,D=function(e){var t,n,r,a;for(t=[],n=0,r=e.length;n<r;++n)a=e[n],t.includes(a)||t.push(a);return e.splice.apply(e,[0,e.length].concat(Q(t))),e},N=function(e){if(null!=e)return u.empty(),navigator.clipboard.writeText(e)},j=function(e){var t,n,r,a;document.activeElement.blur(),(t=document.body.createTextRange)?((n=r=t()).moveToElementText(e),n.select()):getSelection?((r=document.createRange()).selectNodeContents(e),(a=u).removeAllRanges(),a.addRange(r)):console.warn("Trình duyệt không hỗ trợ Selection.")},_=function(){return!/^(?:input|textarea)$/.test(document.activeElement.localName)},M=function(e){var t;"string"==typeof e&&(e={code:e}),t=new KeyboardEvent("keyup",e),dispatchEvent(t)},$=function(e,t){var n,r,a,i;null==t&&(t="solid 2px #07d"),C.includes(e)||(n=e.style,r=n.outline,a=n.outlineOffset,(i=e.style).outline=t,i.outlineOffset="-1px",C.push(e),setTimeout(function(){var t;(t=e.style).outline=r,t.outlineOffset=a,C.splice(C.indexOf(e),1)},400))},H=function(e){null==e&&(e=Z),null!=e&&e.parentElement.querySelectorAll("ul").forEach(function(e){return e.hidden=!0})},I=function(e){null==e&&(e=Z),null!=e&&e.parentElement.querySelectorAll("ul").forEach(function(e){return e.hidden=!1})},U=function(e){var t,n,r,a,i,o,c,s;if(null==e&&(e=Z),e)if(r=(t=e.parentElement)[n="$_Taxonomy_keepITagUl_innerHTML"])t.innerHTML=r,delete t[n];else{for(t[n]=t.innerHTML,a=0,o=(i=t.children).length;a<o;++a)s=(c=i[a]).querySelector("i").innerText,x.test(c.innerText)&&(s+=" †"),c.innerText=s;j(t)}},P=function(e,t){var n,r;null==t&&(t=5e3),(n=r=document.createElement("div")).className="taxonNotify",n.innerHTML=e,document.body.appendChild(r),setTimeout(r.remove,t)},O=function(){return open("https://api.imgur.com/oauth2/authorize?client_id=92ac14aabe20918&response_type=token&state=taxonomy","_blank")},G=async function(e){var n,r;c&&(c.destroy(),c=null),a?(document.querySelector(".hm60ue"),3===(n=document.querySelectorAll(".VSIspc")).length&&n[1].remove(),3===(n=document.querySelectorAll(".ZGGHx")).length&&n[1].remove(),(e=(e=document.querySelectorAll(".n3VNCb"))[3===e.length?1:0]).parentElement.href="javascript:",r=await(await fetch("https://cors-anywhere.herokuapp.com/"+e.src)).blob(),e.src=await new Promise(function(e){var t;(t=new FileReader).onload=function(t){e(t.target.result)},t.readAsDataURL(r)})):t&&document.querySelector(".mw-mmv-download-dialog"),e&&(c=new Cropper(e,{checkCrossOrigin:!1,zoomable:!1,guides:!1,center:!1,ready:function(){this.cropper.setCropBoxData({left:0,top:0,width:0,height:0})}}))},B=async function(e,t){var n,r,a,i,o,u,m;r=(n=null!=e?e:{}).image,a=n.type,s=!0,l?(P("Đang upload ảnh imgur..."),(i=o=new FormData).append("image",r),i.append("album","RPTWQrk"),i.append("type",a),(u=await fetch("https://api.imgur.com/3/image",{method:"post",headers:{Authorization:"Bearer "+l},body:o})).ok?200===(u=await u.json()).status?(c&&(c.destroy(),c=null),await N(" # "+u.data.id),location.href="https://imgur.com/edit?deletehash="+u.data.deletehash+"&album_id=RPTWQrk"):m=Error("Lấy thông tin ảnh imgur thất bại"):m=Error("Upload ảnh imgur thất bại")):m=Error("Chưa có token"),m&&P(m.message),s=!1,"function"==typeof t&&t(m,u.data)},W=function(){chrome.runtime.sendMessage("closeTab")},window.addEventListener("keydown",function(e){e.repeat||S.test(e.code)||(i=e.code)}),window.addEventListener("keyup",async function(e){var n,l,u,m,d,f,g,b,k,w,q,C,Z,P,F,J,X,Y,ee,te,ne,re,ae,ie,oe,ce,se,le,ue,me,pe,de,he=async function(){switch(i){case"KeyP":return m.match(z);case"Semicolon":return m.match(L);case"KeyL":return m.match(A);default:return m.match(/^[A-Z][a-z]+/)}};if(p?(i=void 0,p=!1):e.isTrusted||S.test(e.code)||(i=e.code),t&&(n="Semicolon"===i||y.some(function(e){return e[1]===i}),e.shiftKey)){if(!n)return;H()}if(T=(getSelection()+"").trim(),_()){if(t){if(T){if(!e.ctrlKey&&document.activeElement===document.body){if(n){if(o="",l=T,navigator.userAgent.includes("Edge")&&(l=l.replace(/([a-z])([A-Z])/,"$1\n$2")),l=l.split(E),u=void 0,(m=l[0])&&("KeyL"===i||"KeyP"===i||"Semicolon"===i))switch(!1){case!(d=y.find(function(e){return e[4].test(m)})):u=d[3],i="";break;case!/[A-Z]\.\s[a-z]\.\s[a-z-]+|[A-Z][a-z]+\s[a-z]{2,}\s[a-z]{2,}/.test(m):i="KeyP"}for(null==u&&(u=y.findIndex(function(e){return e[1]===i}))<0&&(u=0),f="\t".repeat((de=u)<0?0:de),g=0,b=l.length;g<b;++g)k=g,(m=(m=l[g]).trim()).match(x)?(m=m.replace(x,""),w=!0):w=!1,m=(m=m.trim().replace(v,"")).replace(/^"(.+)"$/,"$1"),(q=await he())&&(q=q[0],w&&(q+="*"),q=f+q),m=q,l[k]=m;l=l.filter(Boolean),l=Q(l.filter(function(e){return!e.includes("*")})).concat(Q(l.filter(function(e){return e.includes("*")}))),D(l),o=("\n"+(o+=V.call(l,"\n"))).replace(/[\r\n]?\t*\bnull\b/g,"").replace(/\ /g," "),"KeyL"===i&&(o.trim()||M("/"))}else switch(i){case"KeyQ":T=T.replace(v,""),o=" # "+T.charAt(0).toUpperCase()+T.slice(1);break;case"Delete":H();break;case"Backspace":U();break;case"KeyZ":o=T}o&&N(o)}}else switch(i){case"KeyZ":history.back();break;case"KeyX":history.forward();break;case"KeyC":e.ctrlKey||(h?h.click():document.URL.includes("commons.wikimedia.org")&&history.back());break;case"KeyS":(C=document.querySelector(".wb-otherproject-species> a"))?C.click():document.URL.includes("species.wikimedia.org")&&history.back();break;case"KeyD":(d=(Z=function(e){return document.querySelector("a.interlanguage-link-target[hreflang="+e+"]")})("vi")||Z("en"))&&d.click()}switch(i){case"KeyE":o&&(o.includes("*")?o=o.replace(/\*/g,""):(o=o.replace(/([^*])\n/g,"$1*\n")).endsWith("*")||(o+="*"),N(o));break;case"KeyW":W();break;case"F1":e.preventDefault(),P=y.map(function(e){return e[0].split("|").join(" | ")+e[1]}).join(": "),alert(P);break;case"KeyA":R=!R;break;case"Backquote":E=K[1];break;case"KeyV":if(!e.ctrlKey)if(F=document.querySelector("h2> #Species, h3> #Species")){for(F=F.parentElement;(F=F.nextElementSibling)&&"ul"!==F.localName;)if(J=F.querySelector("ul")){F=J;break}F&&(j(F),M("KeyL"),$(F))}else(F=document.querySelector("table.infobox.biota .species"))&&(j(F),M("KeyL"),$(F));break;case"Digit2":case"Digit3":for(P="",g=0,b=(X=(F=document.querySelector(".mw-parser-output")).querySelectorAll(":scope> h"+i[5])).length;g<b;++g)if(!(Y=X[g]).querySelector("#References")){for(ee=Y;"ul"!==ee.localName;)ee=ee.nextElementSibling;for(P+="\n"+"\t".repeat(29)+Y.children[0].textContent,te=0,re=(ne=ee.children).length;te<re;++te)if(ie=(ae=ne[te]).querySelector("i").textContent.split(" ")[1],P+="\n"+"\t".repeat(34)+ie,oe=ae.querySelector("ul"))for(P+="\n"+"\t".repeat(35)+ie,ce=0,le=(se=oe.children).length;ce<le;++ce)ie!==(ue=se[ce].querySelector("i").textContent.split(" ")[2])&&(P+="\n"+"\t".repeat(35)+ue)}N(P);break;case"KeyO":C="https://en.wikipedia.org/wiki/"+(P=await navigator.clipboard.readText()),e.shiftKey?open(C):location.href=C}e.shiftKey&&I()}else if(r){if("/edit"===location.pathname)switch(i){case"KeyS":document.querySelector("#save").click();break;case"KeyR":document.querySelector("#reset-crop").click()}else switch(i){case"KeyE":document.querySelector(".post-image-option.help>a").click()}switch(i){case"KeyZ":history.back();break;case"KeyW":W()}}switch(i){case"KeyN":a&&G();break;case"KeyM":s||(document.contains(null!=c?c.element:void 0)?(me=(me=c.getCroppedCanvas().toDataURL("image/jpeg")).replace("data:image/jpeg;base64,",""),pe="base64"):a&&(me=document.querySelectorAll(".n3VNCb")[1].src,pe="URL"),me&&B({image:me,type:pe}));break;case"KeyK":confirm("Lấy token imgur mới?")&&O();break;case"Escape":c&&(c.destroy(),c=null)}}S.test(i)||(i=void 0),0}),document.addEventListener("mousedown",function(e){var n,o,c,l,u,m,d,h,f,g,b,k,K,w,v,x,S,E,z,L,A,C,R,D,I,P,O,W,F,V;if(Z=null,T=(getSelection()+"").trim(),e.buttons,o=(n=e.target).localName,_())switch(e.which){case 3:switch(!1){case!r:"img"===o&&((c=document.createElement("a")).href=n.src,l=c.pathname.slice(1,8),e.altKey?N(l):(m(e.shiftKey),N(m+l)),$(n));break;case!a:"img"===o&&(e.ctrlKey||(N(n.src),$(n)));break;case!t:switch(!1){case"img"!==o:switch(i){case"KeyN":G(n),p=!0;break;case"KeyM":s||B({image:n.src,type:"URL"}),p=!0;break;default:if(!e.ctrlKey){if(u=n.src,e.altKey)N(u);else{switch(!1){case!/\/\d+px-.+/.test(u):u=u.replace("https://upload.wikimedia.org/wikipedia/commons/thumb","").replace(/\/\d+px-.+/,"");break;case!/-\d+px-.+/.test(u):u=u.replace(/-\d+px-/,"-220px-")}m=e.shiftKey?" | ":" # ",(d={KeyF:"fossil",KeyR:"restoration",KeyC:"reconstruction",KeyE:"exhibit",KeyD:"drawing",KeyH:"holotype",KeyS:"skull",KeyK:"skeleton",KeyJ:"jaw",KeyM:"mandible",KeyI:"illustration",KeyP:"specimen"}[i]||"")&&(d=" ; "+d,p=!0),N(m+u+d)}$(n)}}break;case!n.closest(".binomial"):j(n),M("KeyL"),$(n);break;case!n.closest(".trinomial"):j(n),M("KeyP"),$(n);break;case!(h=n.closest(q)):f=y.find(function(e){return e[2]===h.className})[1],j(n),M(f),$(n);break;case!T:M("KeyL");break;case"li"!==o:if(e.altKey){for(g="$_Taxonomy_linkOpened",b=0,k=!1,K=0,v=(w=n.parentElement.children).length;K<v&&((x=w[K])[g]||(x[g]=!0,!(S=x.querySelector(":scope> i> a:not(.new), :scope> a:not(.new)"))||(S.style.textDecoration="underline",e.shiftKey||(k=!0,open(S.href)),10!=++b)));++K);b||$(n.parentElement,"solid 2px #f43"),k&&chrome.extension.sendMessage("openTabs")}else H(n),n.parentElement.firstElementChild.querySelector("i:first-child> a")||U(n),j(n.parentElement),f="KeyL",(E=n.closest(".infobox.biota")&&/Genus|Genera/.exec(n.closest("tr").previousElementSibling.innerText))||(z=null!=(w=n.parentElement)?w.previousElementSibling:void 0)&&(E=z.querySelector("#Genera")||(null!=(L=z.previousElementSibling)?L.querySelector("#Genera"):void 0)),E&&(f="KeyC"),M(f),$(n.parentElement);break;case!n.closest(".infobox.biota"):if(e.altKey){for(g="$_Taxonomy_linkOpened",b=0,k=!1,K=0,v=(A=n.children).length;K<v&&((x=A[K])[g]||(x[g]=!0,!(S=x.querySelector(":scope> a:not(.new)"))||(S.style.textDecoration="underline",e.shiftKey||(k=!0,open(S.href)),10!=++b)));++K);b||$(n,"solid 2px #f43"),k&&chrome.extension.sendMessage("openTabs")}else(S=n.closest("a:not(.selflink)"))?open(S.href):(f="KeyL",(C=n.closest("td"))&&(R=null!=(A=C.previousElementSibling)?A.textContent.trim().toLowerCase().replace(/[^a-z]/g,""):void 0)&&(D=y.find(function(e){return e[5].test(R)}))&&(f=D[1]),(I=C.querySelector("a"))&&(C=I),j(C),M(f),$(C));break;case!(("th"===o||"td"===o)&&(P=n.closest("table"))):e.ctrlKey||(O=e.shiftKey?Q(P.rows).filter(function(e){var t,n,r,a;if((t=Q(e.cells)).every(function(e){return"th"===e.localName}))return!1;for(n=0,r=t.length;n<r;++n)(a=t[n]).rowSpan>1&&a.remove();return!0}).map(function(e){return e.cells[n.cellIndex]}):Q(P.rows).slice(n.parentElement.rowIndex).map(function(e){return e.cells[n.cellIndex]}),(W=F=document.createElement("ul")).className="pointer-events-none",W.innerHTML=O.map(function(e){return"<li>"+e.innerHTML+"</li>"}).join(""),P.replaceWith(F),j(F),M(i||"KeyL"),$(F));break;case!(V=n.closest("#firstHeading,b,h1,h2,h3,h4,h5,h6")):j(V),M("KeyQ"),$(V)}}}},!0),document.addEventListener("mouseup",function(e){var n,a,o;switch(Z=null,a=(n=e.target).localName,e.which){case 1:switch(!1){case!t:1===e.detail&&(/^(li|a|b|i)$/.test(a)||"p"===a&&n.closest(".infobox.biota"))&&(e.altKey||R&&("a"!==a||"a"===a&&!n.href)&&(j(n.parentElement),Z=n));break;case!r:1===e.detail&&"img"===a&&n.closest(".post-image-container").querySelector(".post-image-option.help>a").click()}break;case 3:t&&("a"!==a||n.classList.contains("selflink")||(n.style.textDecoration="underline",open(n.href)),(o=document.querySelector("ul.pointer-events-none"))&&o.classList.remove("pointer-events-none"))}i||0},!0),document.addEventListener("contextmenu",function(e){e.x&&e.preventDefault()},!0),r||chrome.storage.sync.get(["token","tokenTime"],function(e){var t,n,r;l=e.token,t=e.tokenTime,l&&t+6048e5>Date.now()||(n=O(),r=setInterval(function(){n.closed&&(clearInterval(r),chrome.storage.sync.get(["token"],function(e){l=e.token}))},1e3))}),window.addEventListener("load",async function(){var e,a,i,o;switch(!1){case!t:n&&((d=document.querySelector("a.interlanguage-link-target[hreflang=vi]"))&&(e=/[^\/]+$/.exec(d.href)[0]),(h=document.querySelector(".wb-otherproject-commons> a"))&&((a=document.createElement("link")).rel="prerender",a.href=h.href,document.head.appendChild(a)),e&&(i=await(await fetch("https://vi.wikipedia.org/api/rest_v1/page/summary/"+e)).json()),o={view:function(){var e,t;return m(".column.taxonRightSide",i?m(".col.column.f-center.p-3.scroll-y",m("h2.taxonSummaryTitle",i.title),(t=null!=(e=i.thumbnail)?e.source:void 0)?m("img.taxonSummaryImg",{src:t}):m("p.text-red.text-center","Không có hình ảnh"),m("p.taxonSummaryExtract",m.trust(i.extract_html))):m(".col.p-3.text-red.text-center","Không có mô tả"),m(".p-3",h?m("p.text-green","Có wiki common"):m("p.text-red","Không có wiki common")))}},a=document.createElement("div"),document.body.appendChild(a),m.mount(a,o));break;case!r:"?state=taxonomy"===location.search&&(l=/access_token=([a-z0-9]+)/.exec(location.hash)[1],chrome.storage.sync.set({token:l,tokenTime:Date.now()},W))}})}).call(this);